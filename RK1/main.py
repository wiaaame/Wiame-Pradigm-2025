# -*- coding: utf-8 -*-
from operator import itemgetter

# -----------------------------------------------------------------------------
# 1. Классы данных (Библиотека - Язык программирования)
# -----------------------------------------------------------------------------

class Lang:
    """Язык программирования (Many-side)"""
    def __init__(self, id, name, popularity, lib_id):
        self.id = id
        self.name = name # Название языка
        self.popularity = popularity # Количественный признак (Популярность, от 1 до 10)
        self.lib_id = lib_id # ID библиотеки (для связи один-ко-многим)

class Lib:
    """Библиотека (One-side)"""
    def __init__(self, id, name):
        self.id = id
        self.name = name # Название библиотеки

class LangLib:
    """
    'Языки программирования в библиотеке' для реализации
    связи многие-ко-многим
    """
    def __init__(self, lib_id, lang_id):
        self.lib_id = lib_id
        self.lang_id = lang_id

# -----------------------------------------------------------------------------
# 2. Тестовые данные
# -----------------------------------------------------------------------------

# Библиотеки (Lib)
libs = [
    Lib(1, 'Стандартная библиотека Python'),
    Lib(2, 'Библиотека для работы с данными'),
    Lib(3, 'Библиотека для веб-разработки'),
    Lib(4, 'Библиотека для машинного обучения'),
    Lib(5, 'Библиотека для научных вычислений'),
]

# Языки программирования (Lang)
langs = [
    Lang(1, 'Python', 10, 1),
    Lang(2, 'Java', 8, 2),
    Lang(3, 'JavaScript', 9, 3),
    Lang(4, 'C++', 7, 1),
    Lang(5, 'C#', 6, 2),
    Lang(6, 'Ruby', 4, 3),
    Lang(7, 'Go', 5, 4),
    Lang(8, 'Rust', 5, 4),
    Lang(9, 'Haskell', 2, 5),
    Lang(10, 'Scala', 3, 5),
]

# Связь многие-ко-многим (LangLib)
# Языки, которые используются в нескольких библиотеках
lang_libs = [
    LangLib(1, 1), # Python в Стандартной библиотеке
    LangLib(2, 1), # Python в Библиотеке для работы с данными
    LangLib(3, 1), # Python в Библиотеке для веб-разработки
    LangLib(4, 1), # Python в Библиотеке для машинного обучения
    LangLib(5, 1), # Python в Библиотеке для научных вычислений
    LangLib(2, 2), # Java в Библиотеке для работы с данными
    LangLib(3, 3), # JavaScript в Библиотеке для веб-разработки
    LangLib(1, 4), # C++ в Стандартной библиотеке
    LangLib(4, 7), # Go в Библиотеке для машинного обучения
    LangLib(4, 8), # Rust в Библиотеке для машинного обучения
    LangLib(5, 9), # Haskell в Библиотеке для научных вычислений
    LangLib(5, 10), # Scala в Библиотеке для научных вычислений
]

# -----------------------------------------------------------------------------
# Основная логика
# -----------------------------------------------------------------------------

def main():
    """Основная функция"""

    # Соединение данных один-ко-многим (Lang.name, Lang.popularity, Lib.name)
    one_to_many = [(l.name, l.popularity, b.name)
                   for b in libs
                   for l in langs
                   if l.lib_id == b.id]

    # Соединение данных многие-ко-многим (Lang.name, Lang.popularity, Lib.name)
    many_to_many_temp = [(b.name, ll.lib_id, ll.lang_id)
                         for b in libs
                         for ll in lang_libs
                         if b.id == ll.lib_id]

    many_to_many = [(l.name, l.popularity, lib_name)
                    for lib_name, lib_id, lang_id in many_to_many_temp
                    for l in langs if l.id == lang_id]

    # -------------------------------------------------------------------------
    # Запрос Д1: Выведите список всех языков, у которых название заканчивается на «on», и названия их библиотек.
    # -------------------------------------------------------------------------
    print('Задание Д1 (Один-ко-многим)')
    # Фильтруем по названию языка, заканчивающемуся на 'on'
    res_d1 = list(filter(lambda x: x[0].endswith('on'), one_to_many))
    # Сортировка по названию языка (произвольная)
    res_d1_sorted = sorted(res_d1, key=itemgetter(0))
    print(res_d1_sorted)

    # -------------------------------------------------------------------------
    # Запрос Д2: Выведите список библиотек со средней популярностью языков в каждой библиотеке,
    # отсортированный по средней популярности.
    # -------------------------------------------------------------------------
    print('\nЗадание Д2 (Один-ко-многим)')
    res_d2_unsorted = []
    # Перебираем все библиотеки
    for b in libs:
        # Список языков в библиотеке
        b_langs = list(filter(lambda x: x[2] == b.name, one_to_many))

        # Если библиотека не пустая
        if len(b_langs) > 0:
            # Популярность языков в библиотеке
            b_popularities = [pop for _, pop, _ in b_langs]

            # Средняя популярность
            avg_popularity = sum(b_popularities) / len(b_popularities)

            res_d2_unsorted.append((b.name, avg_popularity))

    # Сортировка по средней популярности (по убыванию)
    res_d2 = sorted(res_d2_unsorted, key=itemgetter(1), reverse=True)
    print(res_d2)

    # -------------------------------------------------------------------------
    # Запрос Д3: Выведите список всех библиотек, у которых название начинается с буквы «Б»,
    # и список работающих в них языков.
    # -------------------------------------------------------------------------
    print('\nЗадание Д3 (Многие-ко-многим)')
    res_d3 = {}
    # Перебираем все библиотеки
    for b in libs:
        # Проверяем, начинается ли название с 'Б'
        if b.name.startswith('Б'):
            # Список языков в библиотеке (из many_to_many)
            b_langs = list(filter(lambda x: x[2] == b.name, many_to_many))

            # Только названия языков
            b_lang_names = [name for name, _, _ in b_langs]

            # Добавляем результат в словарь
            # ключ - библиотека, значение - список языков
            res_d3[b.name] = b_lang_names

    print(res_d3)

if __name__ == '__main__':
    main()
